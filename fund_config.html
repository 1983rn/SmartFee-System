{% extends "base.html" %}

{% block title %}Fund Configuration - SmartFee System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-cog me-2"></i>Fund Configuration</h2>
    <a href="{{ url_for('add_fund_config') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>New Configuration
    </a>
</div>

<!-- Current Active Configuration -->
{% if active_config %}
<div class="card mb-4 border-success">
    <div class="card-header bg-success text-white">
        <h5><i class="fas fa-check-circle me-2"></i>Current Active Configuration</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <h6>Term/Period</h6>
                <p class="h4 text-primary">{{ active_config.decrypted_term_name }}</p>
            </div>
            <div class="col-md-3">
                <h6>PTA Fund Required</h6>
                <p class="h4 text-success">MK{{ active_config.pta_amount|comma }}</p>
            </div>
            <div class="col-md-3">
                <h6>SDF Required</h6>
                <p class="h4 text-info">MK{{ active_config.sdf_amount|comma }}</p>
            </div>
            <div class="col-md-3">
                <h6>Boarding Fee Required</h6>
                <p class="h4 text-warning">MK{{ active_config.boarding_amount|comma }}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-8">
                <div class="alert alert-info">
                    <strong>Note:</strong> Students are considered "Paid in Full" when they have paid exactly 
                    <strong>MK{{ active_config.pta_amount|comma }}</strong> for PTA Fund, 
                    <strong>MK{{ active_config.sdf_amount|comma }}</strong> for SDF, and 
                    <strong>MK{{ active_config.boarding_amount|comma }}</strong> for Boarding Fee.
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success" disabled title="Already Active">
                        <i class="fas fa-check me-2"></i>Active
                    </button>
                    <a href="{{ url_for('edit_fund_config', config_id=active_config.id) }}" class="btn btn-outline-primary" title="Edit Configuration">
                        <i class="fas fa-edit me-2"></i>Edit
                    </a>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteConfig('{{ active_config.id }}', '{{ active_config.decrypted_term_name }}')" title="Delete Configuration">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <h5><i class="fas fa-exclamation-triangle me-2"></i>No Active Configuration</h5>
    <p>Please create a fund configuration to set the required PTA, SDF, and Boarding Fee amounts for this term.</p>
    <a href="{{ url_for('add_fund_config') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Create Configuration
    </a>
</div>
{% endif %}

<!-- Configuration History -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-history me-2"></i>Configuration History</h5>
    </div>
    <div class="card-body">
        {% if configs %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Term/Period</th>
                        <th>PTA Amount</th>
                        <th>SDF Amount</th>
                        <th>Boarding Amount</th>
                        <th>Total Required</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in configs %}
                    <tr class="{{ 'table-success' if config.is_active else '' }}">
                        <td>
                            <strong>{{ config.decrypted_term_name }}</strong>
                            {% if config.is_active %}
                            <span class="badge bg-success ms-2">Active</span>
                            {% endif %}
                        </td>
                        <td class="text-success">MK{{ config.pta_amount|comma }}</td>
                        <td class="text-info">MK{{ config.sdf_amount|comma }}</td>
                        <td class="text-warning">MK{{ config.boarding_amount|comma }}</td>
                        <td class="text-primary">
                            <strong>MK{{ (config.pta_amount + config.sdf_amount + config.boarding_amount)|comma }}</strong>
                            <br><small class="text-muted">Total Required</small>
                        </td>
                        <td>
                            {% if config.is_active %}
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Active</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-pause me-1"></i>Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ config.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if not config.is_active %}
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="confirmActivateConfig('{{ config.id }}', '{{ config.decrypted_term_name }}')" title="Activate">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                <a href="{{ url_for('edit_fund_config', config_id=config.id) }}" class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteConfig('{{ config.id }}', '{{ config.decrypted_term_name }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-cog fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No configurations created yet</h5>
            <p class="text-muted">Create your first fund configuration to get started</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Information Panel -->
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h5><i class="fas fa-info-circle me-2"></i>How Fund Configuration Works</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Purpose</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Sets standard fee amounts for each term</li>
                    <li><i class="fas fa-check text-success me-2"></i>Defines "Paid in Full" criteria</li>
                    <li><i class="fas fa-check text-success me-2"></i>Ensures consistency across all students</li>
                    <li><i class="fas fa-check text-success me-2"></i>Allows easy fee updates between terms</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Impact</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-arrow-right text-primary me-2"></i>New students use active configuration</li>
                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Payment status calculations updated</li>
                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Receipt generation criteria adjusted</li>
                    <li><i class="fas fa-arrow-right text-primary me-2"></i>Reports reflect current requirements</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for deleting configurations -->
<form id="deleteConfigForm" method="POST" class="d-none">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
function confirmDeleteConfig(configId, termName) {
    if (confirm(`Are you sure you want to delete this fund configuration?\n\nTerm/Period: ${termName}\n\nThis action cannot be undone.`)) {
        const form = document.getElementById('deleteConfigForm');
        form.action = `/delete_fund_config/${configId}`;
        form.submit();
    }
}

function confirmActivateConfig(configId, termName) {
    if (confirm(`Are you sure you want to activate this fund configuration?\n\nTerm/Period: ${termName}\n\nThis will deactivate all other configurations and make this one the active configuration for fee calculations.`)) {
        const form = document.getElementById('deleteConfigForm');
        form.action = `/activate_fund_config/${configId}`;
        form.submit();
    }
}
</script>
{% endblock %}
