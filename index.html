{% extends "base.html" %}

{% block title %}Dashboard - {{ school_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
    <div class="d-flex align-items-center">
        <button class="btn btn-outline-primary btn-sm me-3" onclick="editSchoolName()">
            <i class="fas fa-edit me-1"></i>Edit School Name
        </button>
        <div class="text-muted">
            <i class="fas fa-calendar me-1"></i>{{ datetime.now().strftime('%B %d, %Y') }}
        </div>
    </div>
</div>

<!-- School Name Edit Modal -->
<div class="modal fade" id="schoolNameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit School Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('school_config') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="school_name" class="form-label">School Name</label>
                        <input type="text" class="form-control" id="school_name" name="school_name" 
                               value="{{ school_name }}" required>
                        <div class="form-text">This name will appear on all pages and reports.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white dashboard-card" onclick="showStudentDetails('total')" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_students }}</h4>
                        <p class="mb-0">Total Students</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white dashboard-card" onclick="showStudentDetails('paid')" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ paid_in_full }}</h4>
                        <p class="mb-0">Paid in Full</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white dashboard-card" onclick="showStudentDetails('outstanding')" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ outstanding_count }}</h4>
                        <p class="mb-0">Outstanding</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- No Payment card removed per request -->
    <div class="col-md-2">
        <div class="card bg-info text-white dashboard-card" onclick="showTodaysNet()" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="todays-net-display">****</h4>
                        <p class="mb-0">Today's Net</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('add_student') }}" class="btn btn-primary btn-lg w-100 mb-2">
                            <i class="fas fa-user-plus me-2"></i>Add Student
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('add_income') }}" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="fas fa-plus-circle me-2"></i>Record Payment
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('add_expenditure') }}" class="btn btn-warning btn-lg w-100 mb-2">
                            <i class="fas fa-minus-circle me-2"></i>Add Expenditure
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('daily_report') }}" class="btn btn-info btn-lg w-100 mb-2">
                            <i class="fas fa-file-alt me-2"></i>Daily Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Summary -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-arrow-up me-2"></i>Today's Income</h5>
            </div>
            <div class="card-body">
                <h5 class="card-title">Today's Income</h5>
                <h3 class="text-success" id="todays-income-display">****</h3>
                <p class="text-muted">Total payments received today</p>
                <div class="mt-2">
                    <small class="text-muted">Includes: Student fees + Other Income</small>
                </div>
                <button class="btn btn-outline-success" onclick="showTodaysIncome()">View Details</button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-arrow-down me-2"></i>Total Expenditure</h5>
            </div>
            <div class="card-body">
                <h5 class="card-title">Total Expenditure</h5>
                <h3 class="text-danger" id="expenditure-amount" style="display: none;">MK{{ total_expenditure|comma }}</h3>
                <h3 class="text-danger" id="expenditure-hidden">****</h3>
                <p class="text-muted">Total expenses for today</p>
                <div class="mt-2">
                    <small class="text-muted">Includes: Student fees + Other Income expenditures</small>
                </div>
                <button id="view-details-btn" class="btn btn-outline-danger" onclick="toggleExpenditureDetails()">
                    <i class="fas fa-eye"></i> View Details
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Details Modal -->
<div class="modal fade" id="dashboardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh dashboard every 5 minutes
    setTimeout(function() {
        location.reload();
    }, 300000);
    
    // No Payment card removed â€” no client fetch needed
    
    // Interactive dashboard functions
    function showStudentDetails(type) {
        const modal = new bootstrap.Modal(document.getElementById('dashboardModal'));
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        // Set modal title based on type
        switch(type) {
            case 'total':
                modalTitle.textContent = 'All Students';
                break;
            case 'paid':
                modalTitle.textContent = 'Students Paid in Full';
                break;
            case 'outstanding':
                modalTitle.textContent = 'Students with Outstanding Balances';
                break;
            case 'no_payment':
                modalTitle.textContent = 'Students Without Any Payment';
                break;
        }
        
        // Show loading
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        modal.show();
        
        // Fetch data
        fetch(`/api/student_details/${type}`)
            .then(response => response.json())
            .then(data => {
                let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                html += '<th>Student ID</th><th>Name</th><th>Form/Class</th><th>PTA Status</th><th>SDF Status</th>';
                if (type === 'outstanding') {
                    html += '<th>Total Outstanding</th>';
                } else if (type === 'no_payment') {
                    html += '<th>Status</th>';
                }
                html += '</tr></thead><tbody>';
                
                data.students.forEach(student => {
                    html += `<tr>`;
                    html += `<td><strong>${student.student_id}</strong></td>`;
                    html += `<td>${student.name}</td>`;
                    html += `<td>${student.form_class}</td>`;
                    html += `<td><span class="badge bg-${student.pta_status === 'Paid' ? 'success' : 'warning'}">MK${student.pta_amount_paid}</span></td>`;
                    html += `<td><span class="badge bg-${student.sdf_status === 'Paid' ? 'success' : 'warning'}">MK${student.sdf_amount_paid}</span></td>`;
                    if (type === 'outstanding') {
                        html += `<td><strong class="text-danger">MK${student.total_outstanding}</strong></td>`;
                    } else if (type === 'no_payment') {
                        html += `<td><span class="badge bg-danger">No Payment</span></td>`;
                    }
                    html += `</tr>`;
                });
                
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
            })
            .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Error loading data. Please try again.</div>';
            });
    }
    
    function showTodaysNet() {
        const modal = new bootstrap.Modal(document.getElementById('dashboardModal'));
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        modalTitle.textContent = "Today's Financial Summary";
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        modal.show();
        
        fetch('/api/todays_financial_summary')
            .then(response => response.json())
            .then(data => {
                // Update dashboard display with actual values
                document.getElementById('todays-net-display').textContent = `MK${data.net}`;
                
                let html = '<div class="row">';
                html += '<div class="col-md-4"><div class="card bg-success text-white"><div class="card-body text-center">';
                html += `<h4>MK${data.income}</h4><p>Total Income</p></div></div></div>`;
                html += '<div class="col-md-4"><div class="card bg-danger text-white"><div class="card-body text-center">';
                html += `<h4>MK${data.expenditure}</h4><p>Total Expenditure</p></div></div></div>`;
                html += '<div class="col-md-4"><div class="card bg-info text-white"><div class="card-body text-center">';
                html += `<h4>MK${data.net}</h4><p>Net Position</p></div></div></div>`;
                html += '</div><hr>';
                
                // Show unique students with consolidated payments
                html += '<h6>Students with Payments</h6>';
                
                // Fetch student payment data separately
                fetch('/api/student_details/net_summary')
                    .then(response => response.json())
                    .then(studentData => {
                        if (studentData.students && studentData.students.length > 0) {
                            html += '<div class="table-responsive"><table class="table table-sm">';
                            html += '<thead><tr><th>Student ID</th><th>Name</th><th>Form</th><th>PTA</th><th>SDF</th><th>Boarding</th><th>Total</th></tr></thead><tbody>';
                            studentData.students.forEach(student => {
                                html += `<tr>`;
                                html += `<td>${student.student_id}</td>`;
                                html += `<td>${student.name}</td>`;
                                html += `<td>${student.form_class}</td>`;
                                html += `<td>MK${student.pta_paid}</td>`;
                                html += `<td>MK${student.sdf_paid}</td>`;
                                html += `<td>MK${student.boarding_paid}</td>`;
                                html += `<td><strong>MK${student.total_paid}</strong></td>`;
                                html += `</tr>`;
                            });
                            html += '</tbody></table></div>';
                        } else {
                            html += '<p class="text-muted">No student payments recorded.</p>';
                        }
                        

                        
                        modalBody.innerHTML = html;
                    })
                    .catch(error => {
                        html += '<p class="text-danger">Error loading student data.</p>';
                        modalBody.innerHTML = html;
                    });
                

            })
            .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Error loading financial data. Please try again.</div>';
            });
    }
    
    // Function to show today's income details
    function showTodaysIncome() {
        fetch('/api/todays_financial_summary')
            .then(response => response.json())
            .then(data => {
                // Update dashboard display with actual value
                document.getElementById('todays-income-display').textContent = `MK${data.income}`;
                
                const modal = new bootstrap.Modal(document.getElementById('dashboardModal'));
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = "Today's Income Details";
                
                let html = '<div class="card bg-success text-white mb-3"><div class="card-body text-center">';
                html += `<h3>MK${data.income}</h3><p class="mb-0">Total Income Today</p></div></div>`;
                html += '<p class="text-muted">Includes: Student fees + Other Income</p>';
                
                modalBody.innerHTML = html;
                modal.show();
            })
            .catch(error => {
                console.error('Error loading income data:', error);
            });
    }
    
    // Function to edit school name
    function editSchoolName() {
        const modal = new bootstrap.Modal(document.getElementById('schoolNameModal'));
        modal.show();
    }
    
    // Function to toggle expenditure details
    function toggleExpenditureDetails() {
        const amountElement = document.getElementById('expenditure-amount');
        const hiddenElement = document.getElementById('expenditure-hidden');
        const btnElement = document.getElementById('view-details-btn');
        
        if (amountElement.style.display === 'none') {
            amountElement.style.display = 'block';
            hiddenElement.style.display = 'none';
            btnElement.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
        } else {
            amountElement.style.display = 'none';
            hiddenElement.style.display = 'block';
            btnElement.innerHTML = '<i class="fas fa-eye"></i> View Details';
        }
    }
</script>
{% endblock %}