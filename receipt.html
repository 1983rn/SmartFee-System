<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt - SmartFee System</title>
</head>
<body>
<!-- Screen only buttons -->
<div class="no-print" style="margin-bottom: 20px; padding: 10px;">
    <a href="{{ url_for('payment_status') }}" style="background: #6c757d; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">‚Üê Back</a>
    <button onclick="window.print()" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">üñ®Ô∏è Print Receipt</button>
</div>

{% for receipt in receipts %}
<!-- Receipt Content -->
<div class="receipt-content" style="border: 2px solid black; padding: 15px; margin-bottom: 20px; font-family: Arial, sans-serif; background: white; height: 45vh; position: relative;">
    
    <!-- Stamp-style Receipt Number -->
    <div class="receipt-stamp" style="position: absolute; top: 10px; right: 10px; background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 8px 12px; border-radius: 50%; border: 3px solid #c44569; font-weight: bold; font-size: 14px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transform: rotate(-15deg);">
        {{ receipt.decrypted_receipt_no or receipt.receipt_no }}
    </div>
    
    <!-- Header -->
    <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px;">
        <h1 style="margin: 0; font-size: 18px; color: black;">{{ school_name }}</h1>
        {% if school_address %}
        <p style="margin: 5px 0; font-size: 12px; color: black;">{{ school_address }}</p>
        {% endif %}
        <p style="margin: 5px 0; font-size: 14px; color: black;">Official Payment Receipt</p>
    </div>
    
    <!-- Student Information -->
    <div style="margin-bottom: 12px;">
        <h3 style="border-bottom: 1px solid black; padding-bottom: 3px; color: black; font-size: 12px;">Student Information</h3>
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>ID:</strong> {{ receipt.decrypted_student_id or receipt.student_id }}</p>
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Name:</strong> {{ receipt.decrypted_student_name or receipt.student_name }}</p>
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Class:</strong> {{ receipt.decrypted_form_class or receipt.form_class }}</p>
    </div>
    
    <!-- Receipt Details -->
    <div style="margin-bottom: 12px;">
        <h3 style="border-bottom: 1px solid black; padding-bottom: 3px; color: black; font-size: 12px;">Receipt Details</h3>
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Date:</strong> {{ receipt.payment_date.strftime('%d/%m/%Y') }}</p>
        {% if receipt.decrypted_deposit_slip_ref or receipt.deposit_slip_ref %}
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Ref:</strong> {{ receipt.decrypted_deposit_slip_ref or receipt.deposit_slip_ref }}</p>
        {% endif %}
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Installment:</strong> {{ receipt.installment_number }}/2</p>
    </div>
    
    <!-- Payment Details -->
    <div style="margin-bottom: 12px;">
        <h3 style="border-bottom: 1px solid black; padding-bottom: 3px; color: black; font-size: 12px;">Payment Details</h3>
        
        {% set pta_receipts = [] %}
        {% set sdf_receipts = [] %}
        {% set boarding_receipts = [] %}
        {% for r in receipts %}
            {% set fee_type = r.decrypted_fee_type or r.fee_type %}
            {% if fee_type == 'PTA' %}
                {% set _ = pta_receipts.append(r) %}
            {% elif fee_type == 'SDF' %}
                {% set _ = sdf_receipts.append(r) %}
            {% elif fee_type == 'Boarding' %}
                {% set _ = boarding_receipts.append(r) %}
            {% endif %}
        {% endfor %}
        
        <div style="border: 1px solid black; font-size: 10px;">
            <div style="background: #f0f0f0; padding: 4px; border-bottom: 1px solid black; font-weight: bold; color: black;">
                <span style="display: inline-block; width: 50%;">Fee Type</span>
                <span style="display: inline-block; width: 50%;">Amount Paid</span>
            </div>
            
            {% if pta_receipts %}
            <div style="padding: 4px; border-bottom: 1px solid black;">
                <span style="display: inline-block; width: 50%; background: #007bff; color: white; padding: 2px 4px; border-radius: 2px; font-size: 9px;">PTA</span>
                <span style="display: inline-block; width: 50%; font-weight: bold; color: green;">MK{{ "%.2f"|format(pta_receipts | sum(attribute='amount_paid')) }}</span>
            </div>
            {% endif %}
            
            {% if sdf_receipts %}
            <div style="padding: 4px; border-bottom: 1px solid black;">
                <span style="display: inline-block; width: 50%; background: #17a2b8; color: white; padding: 2px 4px; border-radius: 2px; font-size: 9px;">SDF</span>
                <span style="display: inline-block; width: 50%; font-weight: bold; color: green;">MK{{ "%.2f"|format(sdf_receipts | sum(attribute='amount_paid')) }}</span>
            </div>
            {% endif %}
            
            {% if boarding_receipts %}
            <div style="padding: 4px;">
                <span style="display: inline-block; width: 50%; background: #ffc107; color: black; padding: 2px 4px; border-radius: 2px; font-size: 9px;">Boarding</span>
                <span style="display: inline-block; width: 50%; font-weight: bold; color: green;">MK{{ "%.2f"|format(boarding_receipts | sum(attribute='amount_paid')) }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Summary -->
    <div style="margin-bottom: 35px;">
        <h3 style="border-bottom: 1px solid black; padding-bottom: 3px; color: black; font-size: 12px;">Payment Summary</h3>
        {% set total_paid = (pta_receipts | sum(attribute='amount_paid')) + (sdf_receipts | sum(attribute='amount_paid')) + (boarding_receipts | sum(attribute='amount_paid')) %}
        {% set total_balance = (pta_receipts[-1].balance if pta_receipts else 0) + (sdf_receipts[-1].balance if sdf_receipts else 0) + (boarding_receipts[-1].balance if boarding_receipts else 0) %}
        
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Total Paid:</strong> <span style="font-size: 12px; color: green; font-weight: bold;">MK{{ "%.2f"|format(total_paid) }}</span></p>
        <p style="color: black; font-size: 10px; margin: 2px 0;"><strong>Balance:</strong> MK{{ "%.2f"|format(total_balance) }}</p>
    </div>
    
    <!-- Footer -->
    <div style="border-top: 2px solid black; padding-top: 10px; text-align: center; position: absolute; bottom: 15px; left: 15px; right: 15px;">
        <p style="margin: 0 0 8px 0; font-size: 12px; line-height: 1.3; color: black;">
            <strong>Note:</strong> This is an official receipt from {{ school_name }}. 
            Please keep this receipt for your records.
        </p>
        <p style="margin: 0; font-size: 10px; color: #666; font-style: italic;">
            Generated by RN_LAB_TECH
        </p>
    </div>
    
</div>
{% endfor %}

<style>
body {
    margin: 0;
    padding: 10px;
    font-family: Arial, sans-serif;
    background: #f5f5f5;
}

.receipt-stamp {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
    color: white !important;
    border: 3px solid #c44569 !important;
    border-radius: 50% !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
    transform: rotate(-15deg) !important;
    font-family: 'Arial Black', Arial, sans-serif !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
}

@media print {
    @page {
        size: A4;
        margin: 10mm;
    }
    
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .no-print {
        display: none !important;
    }
    
    body {
        margin: 0 !important;
        padding: 0 !important;
        font-size: 10pt !important;
        color: black !important;
        background: white !important;
        width: 100% !important;
        height: 100% !important;
    }
    
    .receipt-content {
        height: 45vh !important;
        margin: 5px 0 !important;
        padding: 10px !important;
        border: 2px solid black !important;
        background: white !important;
        width: 100% !important;
        box-sizing: border-box !important;
        page-break-inside: avoid !important;
        position: relative !important;
    }
    
    .receipt-content:nth-child(odd) {
        page-break-after: avoid !important;
    }
    
    .receipt-content:nth-child(even) {
        page-break-after: always !important;
    }
    
    .receipt-stamp {
        position: absolute !important;
        top: 5px !important;
        right: 5px !important;
        font-size: 12px !important;
        padding: 6px 10px !important;
    }
    
    h1, h3, p, span, div, strong {
        color: black !important;
        font-family: Arial, sans-serif !important;
    }
    
    h1 {
        font-size: 14pt !important;
        margin: 0 0 5pt 0 !important;
    }
    
    h3 {
        font-size: 10pt !important;
        margin: 5pt 0 3pt 0 !important;
    }
    
    p {
        font-size: 8pt !important;
        margin: 1pt 0 !important;
        line-height: 1.1 !important;
    }
}
</style>
</body>
</html>
